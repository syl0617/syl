<!DOCTYPE html>
<html>

<head>
	<title>Map</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<style>
		canvas {
			border: 1px solid black;
		}


		* {
			padding: 50;
			margin: 50;
			-webkit-box-sizing: border-box;
			-moz-box-sizing: border-box;
			box-sizing: border-box;
		}
	</style>
</head>

<body>
	<canvas id="myCanvas" width="500" height="500"></canvas>

	<script type="text/javascript" src="data.json"></script>

	<script>
		function getRandomColor() {
			const r = Math.floor(Math.random() * 256);
			const g = Math.floor(Math.random() * 256);
			const b = Math.floor(Math.random() * 256);
			return `rgb(${r},${g},${b})`;
		}


		// Define the border points
		var fr_border = [
			[51.0833333, -4.783333333333333],
			[51.0833333, 8.216666666666667],
			[42.3333333, 8.216666666666667],
			[42.3333333, -4.783333333333333],
			[51.0833333, -4.783333333333333]
		];


		
		var year = 1995
		var month = 6
		var scale = 0.1

		// Define the canvas element
		var canvas = document.getElementById("myCanvas");
		var ctx = canvas.getContext("2d");
		ctx.antialias = 'subpixel';


		// set the fill color to white
		ctx.fillStyle = 'white';

		// fill the entire canvas with white
		ctx.fillRect(0, 0, canvas.width, canvas.height);


		var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

		ctx.fRect = function (x, y, w, h) {
			x = parseInt(x);
			y = parseInt(y);
			ctx.fillRect(x, y, w, h);
		}


		function drawGridLines(color) {
			// Set stroke style for grid lines
			ctx.strokeStyle = color;

			// Draw vertical grid lines
			for (let i = 0; i < 500; i += 2) {
				ctx.beginPath();
				ctx.moveTo(i, 0);
				ctx.lineTo(i, 500);
				ctx.stroke();
			}

			// Draw horizontal grid lines
			for (let j = 0; j < 500; j += 2) {
				ctx.beginPath();
				ctx.moveTo(0, j);
				ctx.lineTo(500, j);
				ctx.stroke();
			}
		}

		// drawGridLines("white");

		// Calculate the scaling factor
		var xScale = canvas.width / (fr_border[1][1] - fr_border[3][1]);
		var yScale = canvas.height / (fr_border[0][0] - fr_border[3][0]);

		// Draw the border
		ctx.beginPath();
		ctx.moveTo((fr_border[0][1] - fr_border[3][1]) * xScale, (fr_border[0][0] - fr_border[3][0]) * yScale);
		for (var i = 1; i < fr_border.length; i++) {
			ctx.lineTo((fr_border[i][1] - fr_border[3][1]) * xScale, (fr_border[i][0] - fr_border[3][0]) * yScale);
		}
		ctx.closePath();
		ctx.stroke();

		function getDataByMonthYear(data, month, year) {
			return data.filter(
				function (json_data) {
					return json_data.month == month & json_data.year == year
				}
			);
		}

		var pixelCoordList = [];

		function getJSONData() {
			fetch('data.json')
				.then(response => response.json())
				.then(data => {
					// use the parsed JSON data here
					json_data = data

					var data_list = getDataByMonthYear(json_data, 6, 1995)


					for (var i = 0; i < data_list.length; i++) {
						var x = (data_list[i].decimalLongitude - fr_border[3][1]) * xScale;
						var y = (fr_border[0][0] - data_list[i].decimalLatitude) * yScale;
						var w = parseInt(data_list[i].rank);
						pixelCoordList.push([x, y, w]);

						drawCircles(pixelCoordList);
						// drawLines(pixelCoordList);
					}
				})
				.catch(error => console.error(error));
		}


		getJSONData();


		// Define the scaling factor for square size
		const scaleFactor = 0.1

		function drawPoints(pixelCoordList) {
			for (let i = 0; i < pixelCoordList.length; i++) {
				const [x, y, weight] = pixelCoordList[i];
				const size = weight * scaleFactor;
				ctx.fillStyle = getRandomColor();
				ctx.fRect(x - size / 2, y - size / 2, size, size);
			}
		}

		function drawLines(pixelCoordList, scale = 0.1) {
			for (let i = 0; i < pixelCoordList.length; i++) {
				const [x, y, weight] = pixelCoordList[i];

				// Define the line color and width
				const lineColor = getRandomColor();
				const lineWidth = 1;
				const scaledLineWidth = parseInt(weight * scale);



				centerX = x;
				centerY = y;

				// Draw the horizontal line
				ctx.beginPath();
				ctx.strokeStyle = lineColor;
				ctx.lineWidth = scaledLineWidth;
				ctx.moveTo(0, centerY);
				ctx.lineTo(canvas.width, centerY);
				ctx.stroke();

				// Draw the vertical line
				ctx.beginPath();
				ctx.strokeStyle = lineColor;
				ctx.lineWidth = scaledLineWidth;
				ctx.moveTo(centerX, 0);
				ctx.lineTo(centerX, canvas.height);
				ctx.stroke();

				console.log(scaledLineWidth);
			}
		}

		function drawCircles(pixelCoordList, scale = 0.1) {
			// ctx.imageSmoothingEnabled = true;

    for (let i = 0; i < pixelCoordList.length; i++) {
        const [x, y, weight] = pixelCoordList[i];

		const circleColor = getRandomColor();
        const lineWidth = 1;
        const scaledLineWidth = weight * scale;

        // Draw the empty circle
        ctx.beginPath();
        ctx.arc(x, y, scaledLineWidth, 0, 2 * Math.PI);
        ctx.strokeStyle = circleColor;
        ctx.lineWidth = lineWidth;
        ctx.stroke();

        console.log(scaledLineWidth);
    }
}



		// drawPoints(pixelCoordList);


		function drawButton(month, year, scale) {

			ctx.putImageData(imageData, 0, 0);
			pixelCoordList = [];

			var data_list = getDataByMonthYear(json_data, month, year)
			console.log(data_list)


			for (var i = 0; i < data_list.length; i++) {
				var x = (data_list[i].decimalLongitude - fr_border[3][1]) * xScale;
				var y = (fr_border[0][0] - data_list[i].decimalLatitude) * yScale;
				var w = parseInt(data_list[i].rank);

				pixelCoordList.push([x, y, w]);

				drawCircles(pixelCoordList, scale);
								// drawLines(pixelCoordList, scale);

			}

		}





		// Define the point list
		// var list = [
		// 	["Ranunculaceae", 43.12681, 6.01939, 97],
		// 	["Iridaceae", 43.12681, 6.01939, 86],
		// 	["Asparagaceae", 43.12681, 6.01939, 91],
		// 	["Liliaceae", 43.18255, 5.94518, 96],
		// 	["Liliaceae", 43.12681, 6.01939, 96],
		// 	["Caprifoliaceae", 43.16348, 6.09282, 72],
		// 	["Apocynaceae", 43.10166, 6.18990, 70],
		// 	["Ranunculaceae", 43.12681, 6.01939, 97],
		// 	["Iridaceae", 43.12681, 6.01939, 86]
		// ];

		// Convert the coordinates to pixels


		// 		// Draw the points

		// 		for (let i = 0; i < pixelCoordList.length; i++) {
		//   const [x, y] = pixelCoordList[i];
		//   //ctx.fillStyle = "red";

		//   ctx.fillStyle = getRandomColor();

		//   ctx.fRect(x, y, 1, 1);
		// //   ctx.fillRect(x, y, 1, 1);
		// }
	</script>

	<form>
		<label for="year-input">Year:</label>
		<select name="year" id="year-input">
			<option value="1969">1969</option>
			<option value="1977">1977</option>
			<option value="1979">1979</option>
			<option value="1980">1980</option>
			<option value="1981">1981</option>
			<option value="1983">1983</option>
			<option value="1984">1984</option>
			<option value="1985">1985</option>
			<option value="1986">1986</option>
			<option value="1987">1987</option>
			<option value="1988">1988</option>
			<option value="1989">1989</option>
			<option value="1990">1990</option>
			<option value="1990">1990</option>
			<option value="1991">1991</option>
			<option value="1992">1992</option>
			<option value="1993">1993</option>
			<option value="1994">1994</option>
			<option value="1995">1995</option>
			<option value="1996">1996</option>
			<option value="1997">1997</option>
			<option value="1998">1998</option>
			<option value="1999">1999</option>
			<option value="2000">2000</option>
		</select>


		<label for="month-input">Month:</label>
		<select name="month" id="month-input">
			<option value="1">1</option>
			<option value="2">2</option>
			<option value="3">3</option>
			<option value="4">4</option>
			<option value="5">5</option>
			<option value="6">6</option>
			<option value="7">7</option>
			<option value="8">8</option>
			<option value="9">9</option>
			<option value="10">10</option>
			<option value="11">11</option>
			<option value="12">12</option>
		</select>

		<label for="scale-input">Scale:</label>
		<input type="text" id="scale-input">

		<button type="submit" onclick="submitNumber()">Submit</button>
	</form>
	<div class="scb"> </div>
	<script>

		function submitNumber() {
			// Get the value of the input field
			event.preventDefault();
			 year = document.getElementById("year-input").value;
			 month = document.getElementById("month-input").value;
			 scale = document.getElementById("scale-input").value;
			// Do something with the number
			drawButton(month, year, scale)
		}



		const parent = document.querySelector('.scb');

		// create a button element to save the screenshot
		const button = document.createElement('button');
		button.textContent = 'Save Screenshot';
		parent.appendChild(button);

		// add a click event listener to the button to save the screenshot
		button.addEventListener('click', function () {
			// get the screenshot image data URL from the canvas
			const dataURL = canvas.toDataURL('image/jpeg', 0.9); // use JPEG format with quality level 0.9

			// create an Image object and set its source to the data URL
			const img = new Image();
			img.src = dataURL;

			// when the image has finished loading, draw it on a new canvas to create the screenshot
			img.onload = function () {


				const screenshotCanvas = document.createElement('canvas');
				screenshotCanvas.width = img.width;
				screenshotCanvas.height = img.height;
				


				const context = screenshotCanvas.getContext('2d');
				context.antialias = 'subpixel';
				context.drawImage(img, 0, 0);



				// create a link element to download the image
				const link = document.createElement('a');
				link.download = year.toString() + month.toString().padStart(2, "0") + '.jpg'; // use '.jpg' file extension for JPEG format
				link.href = screenshotCanvas.toDataURL('image/jpeg',
				0.9); // use JPEG format with quality level 0.9
				link.click();
			};
		});
	</script>

</html>
